//
// Created by machiry on 12/28/16.
//
#include "bug_detectors/warnings/VulnerabilityWarning.h"

using namespace llvm;

namespace DRCHECKER {

    void VulnerabilityWarning::printCompleteWarning(llvm::raw_ostream &O) const {
        O << "Potential vulnerability detected by: " << this->found_by << "\n";
        O << " " << this->warning_string << "\n";
        O << "  at: ";
        InstructionUtils::printInst(this->target_instr,O);
        O << "  Call Context:\n";
        for(Instruction *currCallSite : this->callSiteTrace) {
            O << "   ";
            InstructionUtils::printInst(currCallSite,O);
        }
        int i = 0;
        for (auto &trace : this->traces) {
            if (trace == nullptr) {
                continue;
            }
            O << "  Instruction Trace " << i++ << " :\n";
            for (InstLoc *currInst : *trace) {
                O << "   ";
                if (currInst) {
                    currInst->print(O);
                }
            }
            O << "\n";
        }
    }

    void VulnerabilityWarning::printWarning(llvm::raw_ostream &O) {
        O << "\"warn_data\":{";
        O << "\"by\":\"";
        O << InstructionUtils::escapeJsonString(this->found_by);
        O << "\",";
        O << "\"warn_str\":\"";
        O << InstructionUtils::escapeJsonString(this->warning_string);
        O << "\",";
        InstLoc il(this->target_instr,&this->callSiteTrace);
        printInstlocJson(&il,O);
        int i = 0;
        for (std::vector<InstLoc*> *trace : this->traces) {
            if (!trace) {
                continue;
            }
            O << ",\"inst_trace_" << i++ << "\":";
            printInstlocTraceJson(trace,O);
        }
        O << "}\n";
    }
}

